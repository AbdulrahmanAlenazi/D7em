<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الحاسبة العلمية | حاسبة.برو</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-btn: rgba(255, 255, 255, 0.05);
            --bg-btn-hover: rgba(255, 255, 255, 0.1);
            --accent: #6c5ce7;
            --accent-light: #a29bfe;
            --accent-glow: rgba(108, 92, 231, 0.3);
            --green: #00cec9;
            --green-glow: rgba(0, 206, 201, 0.3);
            --red: #ff6b6b;
            --text: #e8e8f0;
            --text-dim: #7f8c9b;
            --border: rgba(255, 255, 255, 0.06);
            --gradient: linear-gradient(135deg, #6c5ce7, #00cec9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Top bar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            flex-shrink: 0;
        }

        .topbar-logo {
            font-size: 16px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }

        .topbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .topbar-actions a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 10px;
            transition: all 0.2s;
            background: var(--bg-btn);
            border: 1px solid var(--border);
        }
        .topbar-actions a:hover { color: var(--text); background: var(--bg-btn-hover); }

        /* Calculator body */
        .calc-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            padding: 0 12px;
            overflow: hidden;
        }

        /* Display */
        .display {
            flex-shrink: 0;
            padding: 16px 20px 20px;
            text-align: left;
            direction: ltr;
        }

        .expression {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--text-dim);
            min-height: 22px;
            margin-bottom: 6px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
        }
        .expression::-webkit-scrollbar { display: none; }

        .result {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(36px, 10vw, 52px);
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: none;
            transition: color 0.2s;
        }
        .result::-webkit-scrollbar { display: none; }
        .result.computing { color: var(--accent-light); }

        /* Mode tabs */
        .mode-section {
            display: flex;
            gap: 8px;
            padding: 0 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .mode-tab {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            font-weight: 600;
            background: var(--bg-btn);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .mode-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Memory bar */
        .memory-bar {
            display: flex;
            gap: 6px;
            padding: 0 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .memory-bar button {
            flex: 1;
            padding: 8px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0, 206, 201, 0.08);
            color: var(--green);
            border: 1px solid rgba(0, 206, 201, 0.15);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .memory-bar button:hover { background: rgba(0, 206, 201, 0.15); }

        /* Buttons */
        .buttons-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0 8px 12px;
            min-height: 0;
        }

        .btn-grid {
            display: grid;
            gap: 8px;
            flex: 1;
        }

        .btn-grid.scientific { grid-template-columns: repeat(5, 1fr); }
        .btn-grid.basic { grid-template-columns: repeat(4, 1fr); }

        button.calc-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: 500;
            padding: 0;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--bg-btn);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        button.calc-btn:active {
            transform: scale(0.94);
            background: var(--bg-btn-hover);
        }

        button.calc-btn.operator {
            background: rgba(108, 92, 231, 0.12);
            color: var(--accent-light);
            border-color: rgba(108, 92, 231, 0.2);
        }
        button.calc-btn.operator:active { background: rgba(108, 92, 231, 0.25); }

        button.calc-btn.func {
            background: transparent;
            color: var(--text-dim);
            font-size: clamp(11px, 2.8vw, 13px);
            border-color: var(--border);
        }
        button.calc-btn.func:active { background: var(--bg-btn); color: var(--text); }

        button.calc-btn.equals {
            background: var(--gradient);
            color: white;
            font-weight: 700;
            border: none;
            box-shadow: 0 4px 15px var(--accent-glow);
        }
        button.calc-btn.equals:active {
            transform: scale(0.94);
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        button.calc-btn.clear {
            background: rgba(255, 107, 107, 0.1);
            color: var(--red);
            border-color: rgba(255, 107, 107, 0.15);
        }
        button.calc-btn.clear:active { background: rgba(255, 107, 107, 0.2); }

        button.calc-btn.span2 { grid-column: span 2; }

        /* History */
        .history-toggle {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: none;
            border-top: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            flex-shrink: 0;
        }

        .history-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }
        .history-panel.open { max-height: 200px; overflow-y: auto; }

        .history-item {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            direction: ltr;
        }
        .history-item:hover { background: var(--bg-btn); }
        .history-result { color: var(--accent-light); }

        /* Angle indicator */
        .angle-indicator {
            position: absolute;
            top: 6px;
            left: 20px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--green);
            background: rgba(0, 206, 201, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
        }

        /* Desktop: show as centered card */
        @media (min-width: 600px) {
            body {
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .topbar {
                position: fixed;
                top: 0;
                right: 0;
                left: 0;
                padding: 16px 24px;
                z-index: 100;
            }
            .calc-body {
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 28px;
                max-height: 700px;
                padding: 8px 12px 12px;
                box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5);
            }
        }

        /* Mobile: full screen */
        @media (max-width: 599px) {
            .topbar { padding: 8px 12px; padding-top: env(safe-area-inset-top, 8px); }
            .calc-body { padding: 0 6px; }
            .display { padding: 8px 14px 14px; }
            .buttons-area { padding: 0 4px 8px; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
            .btn-grid { gap: 5px; }
            button.calc-btn { border-radius: 12px; }
            .memory-bar { padding: 0 4px; gap: 4px; margin-bottom: 8px; }
            .mode-section { padding: 0 4px; gap: 6px; margin-bottom: 8px; }
        }

        @media (max-width: 380px) {
            .btn-grid { gap: 4px; }
            button.calc-btn { border-radius: 10px; }
            .memory-bar button { padding: 6px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <a href="/" class="topbar-logo">حاسبة.برو</a>
        <div class="topbar-actions">
            {% if current_user.is_authenticated %}
            <a href="/profile">حسابي</a>
            {% endif %}
            <a href="/">الرئيسية</a>
        </div>
    </div>

    <div class="calc-body">
        <div class="display" style="position: relative;">
            <span class="angle-indicator" id="modeLabel">RAD</span>
            <div class="expression" id="expression"></div>
            <div class="result" id="result">0</div>
        </div>

        <div class="mode-section">
            <button class="mode-tab active" onclick="switchMode('scientific', this)">علمية</button>
            <button class="mode-tab" onclick="switchMode('basic', this)">أساسية</button>
        </div>

        <div class="memory-bar">
            <button onclick="memoryClear()">MC</button>
            <button onclick="memoryRecall()">MR</button>
            <button onclick="memoryAdd()">M+</button>
            <button onclick="memorySub()">M-</button>
            <button onclick="memoryStore()">MS</button>
        </div>

        <div class="buttons-area">
            <!-- Scientific Mode -->
            <div class="btn-grid scientific" id="scientificGrid">
                <button class="calc-btn func" onclick="toggleAngle()" id="angleBtn">RAD</button>
                <button class="calc-btn func" onclick="appendFunc('sin(')">sin</button>
                <button class="calc-btn func" onclick="appendFunc('cos(')">cos</button>
                <button class="calc-btn func" onclick="appendFunc('tan(')">tan</button>
                <button class="calc-btn func" onclick="appendFunc('log(')">log</button>

                <button class="calc-btn func" onclick="toggleInverse()">INV</button>
                <button class="calc-btn func" onclick="appendFunc('asin(')">sin&#8315;&#185;</button>
                <button class="calc-btn func" onclick="appendFunc('acos(')">cos&#8315;&#185;</button>
                <button class="calc-btn func" onclick="appendFunc('atan(')">tan&#8315;&#185;</button>
                <button class="calc-btn func" onclick="appendFunc('ln(')">ln</button>

                <button class="calc-btn func" onclick="append('\u03C0')">&#960;</button>
                <button class="calc-btn func" onclick="append('e')">e</button>
                <button class="calc-btn func" onclick="appendFunc('\u221A(')">&#8730;</button>
                <button class="calc-btn func" onclick="append('^')">x&#696;</button>
                <button class="calc-btn func" onclick="appendFunc('abs(')">|x|</button>

                <button class="calc-btn func" onclick="append('(')">(</button>
                <button class="calc-btn func" onclick="append(')')">)</button>
                <button class="calc-btn func" onclick="append('!')">n!</button>
                <button class="calc-btn func" onclick="append('%')">%</button>
                <button class="calc-btn clear" onclick="clearAll()">AC</button>

                <button class="calc-btn" onclick="append('7')">7</button>
                <button class="calc-btn" onclick="append('8')">8</button>
                <button class="calc-btn" onclick="append('9')">9</button>
                <button class="calc-btn operator" onclick="append('\u00F7')">&#247;</button>
                <button class="calc-btn clear" onclick="backspace()">&#9003;</button>

                <button class="calc-btn" onclick="append('4')">4</button>
                <button class="calc-btn" onclick="append('5')">5</button>
                <button class="calc-btn" onclick="append('6')">6</button>
                <button class="calc-btn operator" onclick="append('\u00D7')">&#215;</button>
                <button class="calc-btn func" onclick="append('^2')">x&#178;</button>

                <button class="calc-btn" onclick="append('1')">1</button>
                <button class="calc-btn" onclick="append('2')">2</button>
                <button class="calc-btn" onclick="append('3')">3</button>
                <button class="calc-btn operator" onclick="append('\u2212')">&#8722;</button>
                <button class="calc-btn func" onclick="append('^3')">x&#179;</button>

                <button class="calc-btn" onclick="append('0')">0</button>
                <button class="calc-btn" onclick="append('.')">.</button>
                <button class="calc-btn equals" onclick="calculate()">=</button>
                <button class="calc-btn operator" onclick="append('+')">+</button>
                <button class="calc-btn func" onclick="append('\u00D710^')">EXP</button>
            </div>

            <!-- Basic Mode -->
            <div class="btn-grid basic" id="basicGrid" style="display:none;">
                <button class="calc-btn clear" onclick="clearAll()">AC</button>
                <button class="calc-btn clear" onclick="backspace()">&#9003;</button>
                <button class="calc-btn operator" onclick="append('%')">%</button>
                <button class="calc-btn operator" onclick="append('\u00F7')">&#247;</button>

                <button class="calc-btn" onclick="append('7')">7</button>
                <button class="calc-btn" onclick="append('8')">8</button>
                <button class="calc-btn" onclick="append('9')">9</button>
                <button class="calc-btn operator" onclick="append('\u00D7')">&#215;</button>

                <button class="calc-btn" onclick="append('4')">4</button>
                <button class="calc-btn" onclick="append('5')">5</button>
                <button class="calc-btn" onclick="append('6')">6</button>
                <button class="calc-btn operator" onclick="append('\u2212')">&#8722;</button>

                <button class="calc-btn" onclick="append('1')">1</button>
                <button class="calc-btn" onclick="append('2')">2</button>
                <button class="calc-btn" onclick="append('3')">3</button>
                <button class="calc-btn operator" onclick="append('+')">+</button>

                <button class="calc-btn span2" onclick="append('0')">0</button>
                <button class="calc-btn" onclick="append('.')">.</button>
                <button class="calc-btn equals" onclick="calculate()">=</button>
            </div>
        </div>

        <button class="history-toggle" onclick="toggleHistory()">
            &#128220; سجل العمليات
        </button>
        <div class="history-panel" id="historyPanel">
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let expression = '';
        let currentResult = '0';
        let memory = 0;
        let isRadians = true;
        let isInverse = false;
        let history = [];

        const exprEl = document.getElementById('expression');
        const resultEl = document.getElementById('result');

        function updateDisplay() {
            exprEl.textContent = expression;
            resultEl.textContent = currentResult;
            exprEl.scrollLeft = exprEl.scrollWidth;
            resultEl.scrollLeft = resultEl.scrollWidth;
        }

        function append(val) {
            expression += val;
            updateDisplay();
            liveEvaluate();
        }

        function appendFunc(func) {
            expression += func;
            updateDisplay();
        }

        function clearAll() {
            expression = '';
            currentResult = '0';
            updateDisplay();
        }

        function backspace() {
            const funcs = ['sin(', 'cos(', 'tan(', 'asin(', 'acos(', 'atan(', 'log(', 'ln(', 'abs(', '\u221A(', '\u00D710^'];
            for (let f of funcs) {
                if (expression.endsWith(f)) {
                    expression = expression.slice(0, -f.length);
                    updateDisplay();
                    liveEvaluate();
                    return;
                }
            }
            expression = expression.slice(0, -1);
            updateDisplay();
            liveEvaluate();
        }

        function toggleAngle() {
            isRadians = !isRadians;
            const label = isRadians ? 'RAD' : 'DEG';
            document.getElementById('modeLabel').textContent = label;
            document.getElementById('angleBtn').textContent = label;
        }

        function toggleInverse() {
            isInverse = !isInverse;
        }

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            if (n > 170) return Infinity;
            let result = 1;
            for (let i = 2; i <= n; i++) result *= i;
            return result;
        }

        function preprocessExpression(expr) {
            let e = expr;
            e = e.replace(/\u00D7/g, '*');
            e = e.replace(/\u00F7/g, '/');
            e = e.replace(/\u2212/g, '-');
            e = e.replace(/\u03C0/g, '(' + Math.PI + ')');
            e = e.replace(/(?<![a-zA-Z])e(?![a-zA-Z^+\-\d])/g, '(' + Math.E + ')');
            e = e.replace(/\^/g, '**');
            e = e.replace(/(\d+)!/g, (_, n) => factorial(parseInt(n)));
            e = e.replace(/(\d+\.?\d*)%/g, '($1/100)');

            if (isRadians) {
                e = e.replace(/sin\(/g, 'Math.sin(');
                e = e.replace(/cos\(/g, 'Math.cos(');
                e = e.replace(/tan\(/g, 'Math.tan(');
            } else {
                e = e.replace(/sin\(/g, 'Math.sin(Math.PI/180*(');
                e = e.replace(/cos\(/g, 'Math.cos(Math.PI/180*(');
                e = e.replace(/tan\(/g, 'Math.tan(Math.PI/180*(');
            }

            e = e.replace(/asin\(/g, 'Math.asin(');
            e = e.replace(/acos\(/g, 'Math.acos(');
            e = e.replace(/atan\(/g, 'Math.atan(');
            e = e.replace(/log\(/g, 'Math.log10(');
            e = e.replace(/ln\(/g, 'Math.log(');
            e = e.replace(/\u221A\(/g, 'Math.sqrt(');
            e = e.replace(/abs\(/g, 'Math.abs(');
            e = e.replace(/\u00D710\*\*/g, '*10**');

            return e;
        }

        function liveEvaluate() {
            if (!expression) {
                currentResult = '0';
                resultEl.classList.remove('computing');
                updateDisplay();
                return;
            }
            try {
                let processed = preprocessExpression(expression);
                let open = (processed.match(/\(/g) || []).length;
                let close = (processed.match(/\)/g) || []).length;
                processed += ')'.repeat(Math.max(0, open - close));

                if (!isRadians) {
                    let extra = (processed.match(/Math\.PI\/180\*\(/g) || []).length;
                    processed += ')'.repeat(extra);
                }

                let result = Function('"use strict"; return (' + processed + ')')();
                if (typeof result === 'number' && !isNaN(result)) {
                    resultEl.classList.add('computing');
                    currentResult = formatNumber(result);
                } else {
                    resultEl.classList.remove('computing');
                }
            } catch {
                resultEl.classList.remove('computing');
            }
            updateDisplay();
        }

        function calculate() {
            if (!expression) return;
            try {
                let processed = preprocessExpression(expression);
                let open = (processed.match(/\(/g) || []).length;
                let close = (processed.match(/\)/g) || []).length;
                processed += ')'.repeat(Math.max(0, open - close));

                if (!isRadians) {
                    let extra = (processed.match(/Math\.PI\/180\*\(/g) || []).length;
                    processed += ')'.repeat(extra);
                }

                let result = Function('"use strict"; return (' + processed + ')')();
                if (typeof result === 'number' && !isNaN(result)) {
                    let formatted = formatNumber(result);
                    history.unshift({ expr: expression, result: formatted });
                    if (history.length > 20) history.pop();
                    renderHistory();
                    expression = formatted;
                    currentResult = formatted;
                    resultEl.classList.remove('computing');
                    updateDisplay();

                    resultEl.style.transform = 'scale(1.03)';
                    setTimeout(() => resultEl.style.transform = 'scale(1)', 150);
                } else {
                    currentResult = '\u062E\u0637\u0623';
                    updateDisplay();
                }
            } catch {
                currentResult = '\u062E\u0637\u0623';
                updateDisplay();
            }
        }

        function formatNumber(n) {
            if (Number.isInteger(n) && Math.abs(n) < 1e15) return n.toString();
            if (Math.abs(n) > 1e15 || (Math.abs(n) < 1e-6 && n !== 0)) {
                return n.toExponential(8);
            }
            return parseFloat(n.toPrecision(12)).toString();
        }

        function memoryClear() { memory = 0; }
        function memoryRecall() { if (memory !== 0) append(memory.toString()); }
        function memoryAdd() { let val = parseFloat(currentResult); if (!isNaN(val)) memory += val; }
        function memorySub() { let val = parseFloat(currentResult); if (!isNaN(val)) memory -= val; }
        function memoryStore() { let val = parseFloat(currentResult); if (!isNaN(val)) memory = val; }

        function switchMode(mode, btn) {
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            if (mode === 'scientific') {
                document.getElementById('scientificGrid').style.display = 'grid';
                document.getElementById('basicGrid').style.display = 'none';
            } else {
                document.getElementById('scientificGrid').style.display = 'none';
                document.getElementById('basicGrid').style.display = 'grid';
            }
        }

        function toggleHistory() {
            document.getElementById('historyPanel').classList.toggle('open');
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = history.map(h =>
                `<div class="history-item" onclick="useHistory('${h.result}')">
                    <span>${h.expr}</span>
                    <span class="history-result">= ${h.result}</span>
                </div>`
            ).join('');
        }

        function useHistory(val) {
            expression = val;
            currentResult = val;
            updateDisplay();
        }

        document.addEventListener('keydown', (e) => {
            const key = e.key;
            if ('0123456789.'.includes(key)) append(key);
            else if (key === '+') append('+');
            else if (key === '-') append('\u2212');
            else if (key === '*') append('\u00D7');
            else if (key === '/') { e.preventDefault(); append('\u00F7'); }
            else if (key === '%') append('%');
            else if (key === '(' || key === ')') append(key);
            else if (key === '^') append('^');
            else if (key === 'Enter' || key === '=') { e.preventDefault(); calculate(); }
            else if (key === 'Backspace') backspace();
            else if (key === 'Escape' || key === 'Delete') clearAll();
        });

        // Prevent zoom on double-tap for iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
